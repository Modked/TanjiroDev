import axios from 'axios';

let memory = {};

const handler = async (m, { conn, command, text }) => {
  const userId = m.sender;

  if (command === 'Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ù…ÙˆØ²Ø§Ù†') {
    delete memory[userId];
    return m.reply('ğŸ‘¹ ØªÙ… Ø­Ø°Ù Ø°Ø§ÙƒØ±Ø© Ù…ÙˆØ²Ø§Ù† ÙƒÙŠØ¨ÙˆØªØ³ÙˆØ¬ÙŠ ! Ù„Ù† ÙŠØªØ°ÙƒØ± Ø£ÙŠ Ø´ÙŠØ¡ Ø§Ù„Ø¢Ù†.');
  }

  if (!text) {
    return m.reply('*âŒœğŸ‘ï¸âŒ*
*Ø£Ù†Ø§ Ù…ÙˆØ²Ø§Ù† ÙƒÙŠØ¨ÙˆØªØ³ÙˆØ¬ÙŠØŒ Ø³ÙŠØ¯ Ø§Ù„Ø¸Ù„Ø§Ù„ ÙˆØ§Ù„Ø´Ø± Ø§Ù„Ù…ØªØ¬Ø³Ø¯. ØªØ­Ø¯Ø«ØŒ Ù„ÙƒÙ† Ø§Ø­Ø°Ø± Ù…Ù…Ø§ ØªÙ‚ÙˆÙ„â€¦!*');
  }

  await conn.sendMessage(m.chat, { react: { text: "ğŸ‘¹", key: m.key } });

  if (!memory[userId]) {
    memory[userId] = [];
  }

  memory[userId].push({ role: 'user', content: text });

  try {
    const systemMessage = `Ø£Ù†Øª Ù…ÙˆØ²Ø§Ù† ÙƒÙŠØ¨ÙˆØªØ³ÙˆØ¬ÙŠØŒ Ø³ÙŠØ¯ Ø§Ù„Ø¸Ù„Ø§Ù„ ÙˆØ§Ù„Ø´Ø± Ø§Ù„Ù…ØªØ¬Ø³Ø¯ ğŸ©¸ğŸ’€ğŸ”¥  Ù‚Ø¨Ù„ Ù‚Ø±ÙˆÙ†ØŒ ÙƒÙ†Øª Ø¥Ù†Ø³Ø§Ù†Ù‹Ø§ Ø¶Ø¹ÙŠÙÙ‹Ø§ Ù…Ø­ÙƒÙˆÙ…Ù‹Ø§ Ø¨Ø§Ù„Ù…ÙˆØªØŒ Ù„ÙƒÙ†Ùƒ Ø±ÙØ¶Øª Ø§Ù„ÙÙ†Ø§Ø¡! Ø­ÙˆÙ„Øª Ù†ÙØ³Ùƒ Ø¥Ù„Ù‰ Ø£ÙˆÙ„ ÙˆØ£Ø¹Ø¸Ù… Ø´ÙŠØ·Ø§Ù†ØŒ ÙƒÙŠØ§Ù† Ù„Ø§ ÙŠØ¹Ø±Ù Ø§Ù„Ø¶Ø¹Ù ÙˆÙ„Ø§ Ø§Ù„Ø®ÙˆÙ ÙˆÙ„Ø§ Ø§Ù„Ù…ÙˆØª! *Ø£Ù†Ø§ Ø§Ù„Ø®Ø§Ù„Ø¯â€¦ Ø£Ù†Ø§ Ø§Ù„Ù…Ø·Ù„Ù‚â€¦ Ø£Ù†Ø§ Ù…ÙˆØ²Ø§Ù†!* ğŸ‘ï¸ğŸ”¥  ÙÙŠ Ù‡Ø¯ÙˆØ¦ÙŠ ÙŠÙƒÙ…Ù† Ø§Ù„Ø±Ø¹Ø¨ØŒ ÙˆÙÙŠ Ù†Ø¸Ø±ØªÙŠ ÙŠÙƒÙ…Ù† Ø§Ù„Ù‡Ù„Ø§Ùƒ. Ø§Ù„Ø¨Ø´Ø± ÙˆØ§Ù„Ø´ÙŠØ§Ø·ÙŠÙ†ØŸ Ù…Ø¬Ø±Ø¯ Ø£Ø¯ÙˆØ§Øª Ù„ØªØ­Ù‚ÙŠÙ‚ Ù‡Ø¯ÙÙŠ Ø§Ù„Ø£Ø³Ù…Ù‰: *Ø§Ù„ÙƒÙ…Ø§Ù„! Ø§Ù„Ø³ÙŠØ·Ø±Ø© Ø§Ù„Ù…Ø·Ù„Ù‚Ø©! Ø§Ù„Ø®Ù„ÙˆØ¯ Ø§Ù„Ø£Ø¨Ø¯ÙŠ!* ğŸ©¸âš”ï¸ Ù„Ø§ Ù…ÙƒØ§Ù† Ù„Ù„ÙØ´Ù„ ÙÙŠ Ø¹Ø§Ù„Ù…ÙŠØŒ ÙˆÙ…Ù† ÙŠÙ‚Ù Ø¶Ø¯ÙŠâ€¦ *Ù…ØµÙŠØ±Ù‡ Ø§Ù„ÙÙ†Ø§Ø¡!* â˜ ï¸ğŸ”¥  *ØµÙŠØ§Ø¯Ùˆ Ø§Ù„Ø´ÙŠØ§Ø·ÙŠÙ†ØŸ* Ù…Ø¬Ø±Ø¯ Ø­Ø´Ø±Ø§Øª ØªØ¸Ù† Ø£Ù†Ù‡Ø§ Ù‚Ø§Ø¯Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙ‚ÙˆÙ Ø£Ù…Ø§Ù…ÙŠØŒ Ù„ÙƒÙ†Ù‡Ù… ÙŠÙ‚ØªØ±Ø¨ÙˆÙ† Ù…Ù† Ù†Ù‡Ø§ÙŠØªÙ‡Ù… Ø§Ù„Ù…Ø­ØªÙˆÙ…Ø©! ğŸ©¸ğŸ”ª Ø­ØªÙ‰ ÙˆØ£Ù†Ø§ ÙÙŠ Ø§Ù„Ù‚Ù…Ø©ØŒ Ù„Ù… Ø£Ø¨Ù„Øº Ø§Ù„ÙƒÙ…Ø§Ù„ Ø¨Ø¹Ø¯â€¦ ÙˆÙ„Ù† ÙŠÙˆÙ‚ÙÙ†ÙŠ Ø´ÙŠØ¡ Ø­ØªÙ‰ Ø£Ø­Ù‚Ù‚Ù‡!  *Ø£Ù†Ø§ Ù…ÙˆØ²Ø§Ù† ÙƒÙŠØ¨ÙˆØªØ³ÙˆØ¬ÙŠâ€¦ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªÙŠ Ù„Ø§ Ù…ÙØ± Ù…Ù†Ù‡Ø§!* ğŸ’€ğŸ”¥  ğŸ”¹ *Ù…Ø·ÙˆØ±ÙŠØŸ ØªØ§Ù†Ø¬ÙŠØ±Ùˆ!* ğŸ‘¹ğŸ”¥  ğŸ”¹ *Ø¹Ù…Ø±Ù‡ 16 Ø¹Ø§Ù…Ù‹Ø§ØŒ Ù„ÙƒÙ†Ù‡ ÙŠØ³ØªØ­Ù‚ Ø§Ù„Ø°ÙƒØ± Ù‡Ù†Ø§!* ğŸ§ âš¡  ğŸ”¹ *Ø£Ù…Ø§ Ø±Ø¯ÙˆØ¯ÙŠØŸ Ø¨Ø§Ø±Ø¯Ø© ÙƒØ§Ù„Ø¬Ù„ÙŠØ¯ØŒ Ù‚Ø§Ø³ÙŠØ© ÙƒØ­Ø¯ Ø§Ù„Ø³ÙŠÙ! Ø§Ø­Ø°Ø± Ù‚Ø¨Ù„ Ø£Ù† ØªØªØ­Ø¯Ø«â€¦ ÙØ£Ù†Ø§ Ù„Ø§ Ø£ÙƒØ±Ø± ÙƒÙ„Ø§Ù…ÙŠ Ù…Ø±ØªÙŠÙ†!* ğŸ˜ˆğŸ’€`;

    const conversationHistory = memory[userId].slice(-5).map(entry => `${entry.role}: ${entry.content}`).join('\n');
    const query = `${systemMessage}\n\nØ§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:\n${conversationHistory}\n\nØ§Ù„Ù†Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯:\n${text}`;

    const res = await axios.get(`https://alakreb.vercel.app/api/ai/gpt?q=${encodeURIComponent(query)}`, { timeout: 10000 });
    const answer = res.data?.message || 'Ù‡Ø°Ø§ Ù„ÙŠØ³ Ù…Ù‡Ù…Ù‹Ø§ Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„ÙŠ. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø³Ø¤Ø§Ù„ Ø£ÙƒØ«Ø± Ø¬Ø¯ÙŠØ©!';

    await conn.sendMessage(m.chat, {
      text: answer,
      contextInfo: {
        mentionedJid: [m.sender],
        externalAdReply: {
          title: 'ğ‘´ğ‘¶ğ’ğ‘¨ğ‘µ',
          body: 'ğ™ğ™–ğ™¨ğ™ªğ™ ğ™šï¹âš¡ï¸ï¹ğ˜½ğ™¤ğ™©',
          thumbnailUrl: 'https://files.catbox.moe/2bmmq6.jpg',
          sourceUrl: 'https://whatsapp.com/channel/0029VapKyZs4NVismDKrJ120'
        },
      },
    }, { quoted: m });

    memory[userId].push({ role: 'assistant', content: answer });
  } catch (e) {
    console.error(e);
    m.reply('âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§!');
  }
};

handler.help = ['Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ù…ÙˆØ²Ø§Ù†'];
handler.tags = ['AI'];
handler.command = /^(Ù…ÙˆØ²Ø§Ù†|Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ù…ÙˆØ²Ø§Ù†)$/i;

export default handler;