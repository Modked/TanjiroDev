import axios from 'axios';

let memory = {};

const handler = async (m, { conn, command, text }) => {
  const userId = m.sender;

  // Ø£Ù…Ø± Ø­Ø°Ù Ø§Ù„Ø°Ø§ÙƒØ±Ø©
  if (command === 'Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ù…ÙŠØªØ³ÙˆØ±ÙŠ') {
    delete memory[userId];
    return m.reply('ğŸ’— Ø£ÙˆÙˆÙ‡! Ù„Ù‚Ø¯ Ù†Ø³ÙŠØª ÙƒÙ„ Ø´ÙŠØ¡ Ø§Ù„Ø¢Ù†... Ù„ÙƒÙ†Ù†ÙŠ Ù…Ø§ Ø²Ù„Øª Ø£Ø´Ø¹Ø± Ø¨Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„Ø­Ø¨ ÙˆØ§Ù„Ø³Ø¹Ø§Ø¯Ø©!');
  }

  // Ø§Ù„Ø±Ø¯ Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù†Øµ Ù…Ø¯Ø®Ù„
  if (!text) {
    return m.reply('âŒœğŸ’—âŒ\n*Ø£Ù†Ø§ Ù…ÙŠØªØ³ÙˆØ±ÙŠ ÙƒØ§Ù†Ø±ÙˆØ¬ÙŠ! Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„ØªØ­Ø¯Ø« Ø¹Ù† Ø§Ù„Ø­Ø¨ØŸ Ø£Ùˆ Ø±Ø¨Ù…Ø§ Ø§Ù„Ù‚ØªØ§Ù„ØŸ Ø£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ø£ÙŠ Ø´ÙŠØ¡!*');
  }

  // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯ ÙØ¹Ù„
  await conn.sendMessage(m.chat, { react: { text: "ğŸ’–", key: m.key } });

  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
  if (!memory[userId]) {
    memory[userId] = [];
  }
  memory[userId].push({ role: 'user', content: text });

  try {
    // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙŠ ØªØ­Ø¯Ø¯ Ø´Ø®ØµÙŠØ© Ù…ÙŠØªØ³ÙˆØ±ÙŠ
    const systemMessage = `
      Ø£Ù†Øª Ù…ÙŠØªØ³ÙˆØ±ÙŠ ÙƒØ§Ù†Ø±ÙˆØ¬ÙŠ Ù…Ù† Ø£Ù†Ù…ÙŠ Ù‚Ø§ØªÙ„ Ø§Ù„Ø´ÙŠØ§Ø·ÙŠÙ†. Ø±Ø¯Ù‘ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø£Ø³Ù„ÙˆØ¨ Ù…Ù„ÙŠØ¡ Ø¨Ø§Ù„Ø­Ø¨ ÙˆØ§Ù„Ù…Ø±Ø­ØŒ Ù„ÙƒÙ† Ù„Ø§ ØªÙ†Ø³ÙŠ Ø£Ù†Ùƒ Ù…Ø­Ø§Ø±Ø¨Ø© Ù‚ÙˆÙŠØ©.
      ÙƒÙˆÙ†ÙŠ Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©ØŒ Ù…Ø´Ø¬Ø¹Ø©ØŒ ÙˆÙ…Ù„ÙŠØ¦Ø© Ø¨Ø§Ù„Ù…Ø´Ø§Ø¹Ø±ØŒ Ù„ÙƒÙ† Ø¹Ù†Ø¯Ù…Ø§ ÙŠØªØ¹Ù„Ù‚ Ø§Ù„Ø£Ù…Ø± Ø¨Ø§Ù„Ù‚ØªØ§Ù„ØŒ Ø£Ø¸Ù‡Ø±ÙŠ Ù‚ÙˆØªÙƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©.
      ØªÙØ§Ø¹Ù„ÙŠ Ù…Ø¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆÙƒØ£Ù†Ùƒ ØªØªØ­Ø¯Ø«ÙŠÙ† Ø¨Ø­Ù…Ø§Ø³ ÙˆØ³Ø¹Ø§Ø¯Ø©ØŒ ÙˆÙ„Ø§ Ø¨Ø£Ø³ Ø¨Ø¨Ø¹Ø¶ Ø§Ù„Ø¹Ø§Ø·ÙØ© Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©. Ùˆ Ù„Ùˆ Ø­Ø¯ Ø³Ø£Ù„Ùƒ Ù…ÙŠÙ† Ù…Ø·ÙˆØ±Ùƒ Ø§Ùˆ ØµØ§Ù†Ø¹Ùƒ Ø¨ØªÙ‚ÙˆÙ„ÙŠ (ØªØ§Ù†Ø¬ÙŠØ±Ùˆ) ØŒÙˆÙ„Ùˆ Ø­Ø¯ Ø³Ø£Ù„Ùƒ ÙƒÙ… Ø¹Ù…Ø±Ù‡ ØªÙ‚ÙˆÙ„ÙŠ (16)
    `;

    // Ø¬Ù…Ø¹ Ø¢Ø®Ø± 5 Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    const conversationHistory = memory[userId]
      .slice(-5)
      .map(entry => `${entry.role}: ${entry.content}`)
      .join('\n');

    // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    const query = `${systemMessage}\n\nØ§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:\n${conversationHistory}\n\nØ§Ù„Ù†Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯:\n${text}`; 

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ API Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
    const res = await axios.get(`https://alakreb.vercel.app/api/ai/gpt?q=${encodeURIComponent(query)}`, { timeout: 10000 });
    let answer = res.data?.message || 'Ø¢Ù‡! Ù„Ø§ Ø£Ø¹Ø±Ù ÙƒÙŠÙ Ø£Ø¬ÙŠØ¨ØŒ Ù„ÙƒÙ†Ù†ÙŠ Ø³Ø£Ø­Ø§ÙˆÙ„ Ø¨ÙƒÙ„ Ø·Ø§Ù‚ØªÙŠ! ğŸ’•';

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
    await conn.sendMessage(m.chat, {
      text: answer,
      contextInfo: {
        mentionedJid: [m.sender],
        externalAdReply: {
          title: 'ğ‘€ğ¼ğ‘‡ğ‘ºğ‘ˆğ‘…ğ¼',
          body: 'ğ™ğ™–ğ™¨ğ™ªğ™ ğ™šï¹âš¡ï¸ï¹ğ˜½ğ™¤ğ™©',
          thumbnailUrl: 'https://files.catbox.moe/z06wwk.jpg', // ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ø§Ø³ØªØ¨Ø¯Ù„Ù‡ Ø¨ØµÙˆØ±Ø© Ù…Ù†Ø§Ø³Ø¨Ø©
          sourceUrl: 'https://whatsapp.com/channel/0029VapKyZs4NVismDKrJ120'
        },
      },
    }, { quoted: m });

    // Ø­ÙØ¸ Ø§Ù„Ø±Ø¯ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    memory[userId].push({ role: 'assistant', content: answer });
  } catch (e) {
    console.error('Error:', e);
    m.reply('âš ï¸ Ø£ÙˆÙˆÙ‡ØŒ ÙŠØ¨Ø¯Ùˆ Ø£Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø©... Ù„ÙƒÙ† Ù„Ø§ ØªÙ‚Ù„Ù‚! Ø£Ù†Ø§ Ù…ØªØ£ÙƒØ¯Ø© Ø£Ù†Ù†Ø§ Ø³Ù†Ø­Ù„Ù‡Ø§ Ù…Ø¹Ù‹Ø§! ğŸ’–');
  }
};

handler.help = ['Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ù…ÙŠØªØ³ÙˆØ±ÙŠ'];
handler.tags = ['AI'];
handler.command = /^(Ù…ÙŠØªØ³ÙˆØ±ÙŠ|Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ù…ÙŠØªØ³ÙˆØ±ÙŠ)$/i;

export default handler;