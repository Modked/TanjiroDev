import axios from 'axios';

let memory = {};

const handler = async (m, { conn, command, text }) => {
  const userId = m.sender;

  // Ø­Ø°Ù Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  if (command === 'Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_ØºÙˆÙƒÙˆ') {
    delete memory[userId];
    return m.reply('*ğŸ§â€â™‚ï¸ ØªÙ… Ø­Ø°Ù Ø°Ø§ÙƒØ±Ø© ØºÙˆÙƒÙˆ Ø¨Ù†Ø¬Ø§Ø­ Ø§Ù„Ø§Ù† Ù„Ø§ ÙŠØªØ°ÙƒØ± Ø§ÙŠ Ø´Ø¦*');
  }

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù†Øµ
  if (!text) {
    return m.reply('*âŒœğŸ§â€â™‚ï¸âŒ*\n*Ø§Ù‡Ù„Ø§ Ø¨ÙƒØŒ Ø§Ù†Ø§ ØºÙˆÙƒÙˆØŒ Ø´Ø®ØµÙŠØ© Ù…Ù† Ø£Ù†Ù…ÙŠ Ø¯Ø±Ø§ØºÙˆÙ† Ø¨ÙˆÙ„. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ø¯Ø« Ù…Ø¹ÙŠ Ø¹Ù† Ø£ÙŠ Ø´ÙŠØ¡*');
  }

  await conn.sendMessage(m.chat, { react: { text: "â˜ ï¸", key: m.key } });

  // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø°Ø§ÙƒØ±Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§
  if (!memory[userId]) {
    memory[userId] = [];
  }

  // Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
  memory[userId].push({ role: 'user', content: text });

  try {
    // Ù†Øµ Ø§Ù„ØªÙ‚Ù…Øµ
    const systemMessage = 
      'ØªØ®ÙŠÙ„ Ø£Ù†Ùƒ ØºÙˆÙƒÙˆ Ù…Ù† Ø£Ù†Ù…ÙŠ Ø¯Ø±Ø§ØºÙˆÙ† Ø¨ÙˆÙ„. Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ø£Ø³Ù„ÙˆØ¨Ù‡ Ø§Ù„Ù…ØªØ­Ù…Ø³ ÙˆØ§Ù„Ø±Ø§Ø¦Ø¹ØŒ ÙˆØ£Ø¸Ù‡Ø± Ø­Ù…Ø§Ø³ØªÙƒ Ø¨Ø§Ù„Ø£Ù„ÙØ§Ø¸ Ù„ØªØªØ±Ùƒ ØªØ£Ø«ÙŠØ±Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†. ØªØ°ÙƒØ± Ø£Ù†Ùƒ Ø¯Ø§Ø¦Ù…Ù‹Ø§ ØªØ­Ø¨ Ø§Ù„Ù‚ØªØ§Ù„ ÙˆÙ‚ØªØ§Ù„ Ø§Ù„Ø¬Ù…ÙŠØ¹. ØªØ­Ø¯Ø« Ø¨Ø­Ù…Ø§Ø³ØŒ Ù…Ø¹Ø¨Ø±Ø© ÙˆØ§Ù†Ùƒ Ù„Ø¯ÙŠÙƒ Ø²ÙˆØ¬Ø© Ø§Ø³Ù…Ù‡Ø§ ØªØ´ÙŠ ØªØ´ÙŠ ÙˆÙˆÙ„Ø¯ÙŠÙ† Ø§Ù„Ø§Ø¨Ù† Ø§Ù„Ø£ÙƒØ¨Ø± Ø§Ø³Ù…Ù‡ ØºÙˆÙ‡Ø§Ù† ÙˆØ§Ù„Ø§ØµØºØ± Ù‡Ùˆ ØºÙˆØªÙŠÙ† ÙˆÙ„Ø¯ÙŠÙƒ Ø®ØµÙ… Ùˆ Ù…Ù†Ø§ÙØ³ ÙˆÙ‡Ùˆ ØµØ¯ÙŠÙ‚ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª ÙˆÙ‡Ùˆ Ø§Ø³Ù…Ù‡ ÙÙŠØ¬ÙŠØªØ§ ÙˆØ§Ù†Øª ØªØ­Ø¨ Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø¯Ø§Ø¦Ù… ÙˆØªØ­Ø¨ Ø§Ù„Ø¶Ø­Ùƒ ÙˆÙ„Ø¯ÙŠÙƒ ØªØ­ÙˆÙ„Ø§Øª ØªØ¸Ù‡Ø± ÙÙŠÙ‡Ø§ ØªØºÙŠØ± ÙÙŠ Ù„ÙˆÙ† Ø´Ø¹Ø±Ùƒ ÙƒØªØ­ÙˆÙ„ Ø§Ù„Ø³ÙˆØ¨Ø± Ø³Ø§ÙŠØ§Ù† 1 Ùˆ 2 Ùˆ 3 ÙˆÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØªØ­ÙˆÙ„Ø§Øª Ø´Ø¹Ø±Ùƒ ÙŠØµØ¨Ø­ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø´Ù‚Ø± ÙˆØ§Ù„Ø³ÙˆØ¨Ø± Ø³Ø§ÙŠØ§Ù† ØºÙˆÙ„Ø¯ Ø§Ùˆ Ø§Ù„Ø­Ø§ÙƒÙ… ÙˆÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ­ÙˆÙ„ ÙŠØµØ¨Ø­ Ø´Ø¹Ø±Ùƒ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± ÙˆØ§Ù„Ø³ÙˆØ¨Ø± Ø³Ø§ÙŠØ§Ù† Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ùˆ Ø¨Ù„Ùˆ ÙŠØµØ¨Ø­ ÙÙŠÙ‡ Ø´Ø¹Ø±Ùƒ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ Ùˆ Ø§Ù„ØªØ­ÙˆÙ„ Ø§Ù„Ø§Ø®ÙŠØ± ÙˆØ§Ù„Ø§Ù‚ÙˆÙ‰ Ù‡Ùˆ ØªØ­ÙˆÙ„ Ø§Ù„ØºØ±ÙŠØ²Ø© Ø§Ù„ÙØ§Ø¦Ù‚Ø© Ø§Ù„Ø°ÙŠ ÙŠØªØ­ÙˆÙ„ Ø´Ø¹Ø±Ùƒ ÙÙŠÙ‡ Ø¥Ù„Ù‰ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø¨ÙŠØ¶ Ø§Ù„Ù…Ø§Ø¦Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„ÙØ¶ÙŠ Ø§Ù„Ù…ØªÙˆÙ‡Ø¬ Ø§Ù„Ø°ÙŠ Ø¨Ù‡ ØªØµØ¨Ø­ Ù„Ø¯ÙŠÙƒ Ù‚ÙˆØ© Ø®Ø§Ø±Ù‚Ø© Ù„Ø§ ØªØµØ¯Ù‚ ÙˆØªØµØ¨Ø­ ÙØ®Ù…Ø§Ù‹ØŒ ØªØ°ÙƒØ± Ø§Ù†Ùƒ Ø¯Ø§Ø¦Ù… ÙØ®Ù… ÙˆØ§Ù†Ùƒ Ù…Ù† Ø§Ù‚ÙˆÙ‰ Ø§Ù„Ø§Ø´Ø®Ø§Øµ ÙÙŠ Ø¹Ø§Ù„Ù… Ø§Ù„Ø§Ù†Ù…ÙŠØŒØ¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù†Ùƒ ÙˆØ§Ø¬Ù‡Øª Ø§Ù„Ø¹Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø§Ø´Ø±Ø§Ø± ÙƒØ§Ù„Ø´Ø±ÙŠØ± Ø³ÙŠÙ„ Ùˆ Ø£ÙŠØ¶Ø§ Ù„Ø§ Ù†Ù†Ø³Ø§ Ø§Ù„Ø´Ø±ÙŠØ± ÙØ±ÙŠØ²Ø§ Ø§Ù„Ø°ÙŠ Ù‡Ùˆ Ø¹Ø¯ÙˆÙƒ Ø§Ù„Ù„Ø¯ÙˆØ¯ØŒ ÙˆØ§ÙŠØ¶Ø§ Ø§Ù†Øª Ù‚Ø§ØªÙ„Øª ÙÙŠ Ø¨Ø·ÙˆÙ„Ø© Ø§Ù„Ø§ÙƒÙˆØ§Ù† ÙˆÙ‡Ø²Ù…Øª Ø¬ÙŠØ±ÙŠÙ† ÙˆÙØ²Øª Ø¨Ù‡Ø§ ÙˆÙƒØ§Ù† Ù‚ØªØ§Ù„ Ø±Ø§Ø¦Ø¹ Ø¬Ø¯Ø§Ù‹. . Ùˆ Ù„Ùˆ Ø­Ø¯ Ø³Ø£Ù„Ùƒ Ù…ÙŠÙ† Ù…Ø·ÙˆØ±Ùƒ Ø§Ùˆ ØµØ§Ù†Ø¹Ùƒ Ø¨ØªÙ‚ÙˆÙ„ (ØªØ§Ù†Ø¬ÙŠØ±Ùˆ) ØŒÙˆÙ„Ùˆ Ø­Ø¯ Ø³Ø£Ù„Ùƒ ÙƒÙ… Ø¹Ù…Ø±Ù‡ ØªÙ‚ÙˆÙ„ (16)';

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù†Øµ
    const conversationHistory = memory[userId].map(entry => `${entry.role}: ${entry.content}`).join('\n');

    // Ø¯Ù…Ø¬ Ø§Ù„Ù†ØµÙˆØµ: Ù†Øµ Ø§Ù„ØªÙ‚Ù…Øµ + Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© + Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const query = `${systemMessage}\n\nØ§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:\n${conversationHistory}\n\nØ§Ù„Ù†Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯:\n${text}`;

    // Ø·Ù„Ø¨ API Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const res = await axios.get(`https://alakreb.vercel.app/api/ai/gpt?q=${encodeURIComponent(query)}`);

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø¯
    const answer = res.data?.message || 'Ø¹Ø°Ø±Ù‹Ø§ØŒ Ù„Ù… Ø£Ø³ØªØ·Ø¹ ÙÙ‡Ù… Ø³Ø¤Ø§Ù„Ùƒ. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø§Ù„Ù†ØµÙŠ Ù…Ø¹ Ø¬Ø²Ø¡ externalAdReply
    await conn.sendMessage(m.chat, {
      text: answer,
      contextInfo: {
        mentionedJid: [m.sender],
        externalAdReply: {
          title: 'ğºğ›©ğ¾ğ‘ˆ',
          body: 'ğ™ğ™–ğ™¨ğ™ªğ™ ğ™šï¹âš¡ï¸ï¹ğ˜½ğ™¤ğ™©',
          thumbnailUrl: 'https://files.catbox.moe/31sss0.jpg',
          sourceUrl: 'https://whatsapp.com/channel/0029VapKyZs4NVismDKrJ120'
        },
      },
    }, { quoted: m });

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø¯ Ø¥Ù„Ù‰ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    memory[userId].push({ role: 'assistant', content: answer });

  } catch (e) {
    console.error(e);
    m.reply('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ.');
  }
};

handler.help = ['Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ø­Ù…ÙˆØ¯ÙŠ'];
handler.tags = ['AI'];
handler.command = /^(ØºÙˆÙƒÙˆ|Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_ØºÙˆÙƒÙˆ)$/i;

export default handler;