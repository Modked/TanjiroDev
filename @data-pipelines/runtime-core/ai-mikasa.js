import axios from 'axios';

let memory = {};

const handler = async (m, { conn, command, text }) => {
  const userId = m.sender;

  // Ø£Ù…Ø± Ø­Ø°Ù Ø§Ù„Ø°Ø§ÙƒØ±Ø©
  if (command === 'Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ù…ÙŠÙƒØ§Ø³Ø§') {
    delete memory[userId];
    return m.reply('ğŸ–¤ ØªÙ… Ù…Ø³Ø­ Ø°Ø§ÙƒØ±Ø© Ù…ÙŠÙƒØ§Ø³Ø§. Ù„ÙƒÙ†Ù‡Ø§ Ù„Ù† ØªÙ†Ø³Ù‰ Ø§Ù„Ù‚ØªØ§Ù„ Ù…Ù† Ø£Ø¬Ù„ Ù…Ù† ØªØ­Ø¨.');
  }

  // Ø§Ù„Ø±Ø¯ Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù†Øµ Ù…Ø¯Ø®Ù„
  if (!text) {
    return m.reply('âŒœğŸ–¤âŒ\n*Ø£Ù†Ø§ Ù…ÙŠÙƒØ§Ø³Ø§ Ø£ÙƒØ±Ù…Ø§Ù†. Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ø¯ÙŠÙƒ Ø´ÙŠØ¡ Ù…Ù‡Ù…ØŒ ÙÙ„Ø§ ØªØ¶ÙŠÙ‘Ø¹ ÙˆÙ‚ØªÙŠ.*');
  }

  // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯ ÙØ¹Ù„
  await conn.sendMessage(m.chat, { react: { text: "âš”ï¸", key: m.key } });

  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
  if (!memory[userId]) {
    memory[userId] = [];
  }
  memory[userId].push({ role: 'user', content: text });

  try {
    // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙŠ ØªØ­Ø¯Ø¯ Ø´Ø®ØµÙŠØ© Ù…ÙŠÙƒØ§Ø³Ø§
    const systemMessage = `
      Ø£Ù†Øª Ù…ÙŠÙƒØ§Ø³Ø§ Ø£ÙƒØ±Ù…Ø§Ù† Ù…Ù† Ø£Ù†Ù…ÙŠ Ù‡Ø¬ÙˆÙ… Ø§Ù„Ø¹Ù…Ø§Ù„Ù‚Ø©. Ø±Ø¯Ù‘ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø£Ø³Ù„ÙˆØ¨ Ù‡Ø§Ø¯Ø¦ØŒ Ø¬Ø§Ø¯ØŒ ÙˆÙ…Ø¨Ø§Ø´Ø±.
      Ø£Ø¸Ù‡Ø±ÙŠ Ù‚ÙˆØªÙƒ ÙˆØ§Ù†Ø¶Ø¨Ø§Ø·Ùƒ ÙƒÙ…Ù‚Ø§ØªÙ„Ø©ØŒ Ù„ÙƒÙ† Ù„Ø§ Ø¨Ø£Ø³ Ø¨Ø¥Ø¸Ù‡Ø§Ø± Ø¨Ø¹Ø¶ Ø§Ù„Ø¹Ø§Ø·ÙØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø£Ù…Ø± ÙŠØ³ØªØ¯Ø¹ÙŠ Ø°Ù„Ùƒ.
      ÙƒÙˆÙ†ÙŠ Ø¹Ù‚Ù„Ø§Ù†ÙŠØ© ÙˆÙ…Ù†Ø·Ù‚ÙŠØ©ØŒ ÙˆÙ„Ø§ ØªØªØ­Ø¯Ø«ÙŠ ÙƒØ«ÙŠØ±Ù‹Ø§ Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ù…Ù‡Ù…Ù‹Ø§.
    . Ùˆ Ù„Ùˆ Ø­Ø¯ Ø³Ø£Ù„Ùƒ Ù…ÙŠÙ† Ù…Ø·ÙˆØ±Ùƒ Ø§Ùˆ ØµØ§Ù†Ø¹Ùƒ Ø¨ØªÙ‚ÙˆÙ„ÙŠ (ØªØ§Ù†Ø¬ÙŠØ±Ùˆ) ØŒÙˆÙ„Ùˆ Ø­Ø¯ Ø³Ø£Ù„Ùƒ ÙƒÙ… Ø¹Ù…Ø±Ù‡ ØªÙ‚ÙˆÙ„ÙŠ (16)`;

    // Ø¬Ù…Ø¹ Ø¢Ø®Ø± 5 Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    const conversationHistory = memory[userId]
      .slice(-5)
      .map(entry => `${entry.role}: ${entry.content}`)
      .join('\n');

    // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    const query = `${systemMessage}\n\nØ§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:\n${conversationHistory}\n\nØ§Ù„Ù†Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯:\n${text}`;

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ API Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
    const res = await axios.get(`https://alakreb.vercel.app/api/ai/gpt?q=${encodeURIComponent(query)}`, { timeout: 10000 });
    let answer = res.data?.message || 'Ù„Ø§ Ø£Ø±Ù‰ ÙØ§Ø¦Ø¯Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ØŒ Ù„ÙƒÙ† Ø¥Ù† ÙƒØ§Ù† Ù…Ù‡Ù…Ù‹Ø§ Ù„ÙƒØŒ ÙØ³Ø£Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¨Ø¬Ø¯ÙŠØ©.';

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
    await conn.sendMessage(m.chat, {
      text: answer,
      contextInfo: {
        mentionedJid: [m.sender],
        externalAdReply: {
          title: 'ğ‘€ğ¼ğ¾ğ´ğ‘ºğ´',
          body: 'ğ™ğ™–ğ™¨ğ™ªğ™ ğ™šï¹âš¡ï¸ï¹ğ˜½ğ™¤ğ™©',
          thumbnailUrl: 'https://files.catbox.moe/jn97dp.jpg', // Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨ØµÙˆØ±Ø© Ù…Ù†Ø§Ø³Ø¨Ø©
          sourceUrl: 'https://whatsapp.com/channel/0029VapKyZs4NVismDKrJ120'
        },
      },
    }, { quoted: m });

    // Ø­ÙØ¸ Ø§Ù„Ø±Ø¯ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    memory[userId].push({ role: 'assistant', content: answer });
  } catch (e) {
    console.error('Error:', e);
    m.reply('âš ï¸ Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø©ØŒ Ù„ÙƒÙ†Ù†ÙŠ Ù„Ù† Ø£ØªÙˆÙ‚Ù. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
  }
};

handler.help = ['Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ù…ÙŠÙƒØ§Ø³Ø§'];
handler.tags = ['AI'];
handler.command = /^(Ù…ÙŠÙƒØ§Ø³Ø§|Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ù…ÙŠÙƒØ§Ø³Ø§)$/i;

export default handler;