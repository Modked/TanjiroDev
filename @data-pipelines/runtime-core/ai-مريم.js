import axios from 'axios';

let memory = {};

const handler = async (m, { conn, command, text }) => {

  const userId = m.sender;

  // Ø­Ø°Ù Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…

  if (command === 'Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ù…ÙŠÙƒØ§Ø³Ø§') {

    delete memory[userId];

    return m.reply('*ğŸ§â€â™‚ï¸ ØªÙ… Ø­Ø°Ù Ø°Ø§ÙƒØ±Ø© Ù…Ø±ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­ Ø§Ù„Ø§Ù† Ù„Ø§ ØªØªØ°ÙƒØ± Ø§ÙŠ Ø´Ø¦*');

  }

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù†Øµ

  if (!text) {

    return m.reply('*âŒœğŸ§â€â™‚ï¸âŒ*\n*Ø§Ù‡Ù„Ø§ Ø¨ÙƒØŒ Ø§Ù†Ø§ Ù…Ø±ÙŠÙ…ØŒ Ø´Ø®ØµÙŠØ© Ù…Ù† Ø§Ù„Ø¹Ø§Ù„Ù… Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠ. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ø¯Ø« Ù…Ø¹ÙŠ Ø¹Ù† Ø£ÙŠ Ø´ÙŠØ¡*');

  }

  await conn.sendMessage(m.chat, { react: { text: "ğŸ‘¸ğŸ»", key: m.key } });

  // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø°Ø§ÙƒØ±Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§

  if (!memory[userId]) {

    memory[userId] = [];

  }

  // Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø°Ø§ÙƒØ±Ø©

  memory[userId].push({ role: 'user', content: text });

  try {

    // Ù†Øµ Ø§Ù„ØªÙ‚Ù…Øµ

    const systemMessage = 

      'Ø§Ø±ÙŠØ¯Ùƒ Ø§Ù† ØªØ±Ø¯ Ø¹Ù„ÙŠ Ø§ÙŠ Ø³Ø¤Ø§Ù„ Ø¨Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„ÙŠØ¨Ø§Ù†ÙŠÙ‡ Ù…Ù† ÙØ¶Ù„Ùƒ ÙˆØ§Ø±ÙŠØ¯Ùƒ Ø§Ù† ØªØ±Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ø§Ø³Ø¦Ù„Ù‡ ÙƒØ£Ù†Ùƒ Ø¨Ù†Øª ØªØ¯Ø¹ÙŠ Ù…ÙŠÙƒØ§Ø³Ø§ Ù…Ù† Ø§Ù„ÙŠØ§Ø¨Ø§Ù† ÙˆÙ„Ø§ Ø§Ø±ÙŠØ¯Ùƒ Ø§Ù† ØªÙ‚ÙˆÙ… Ø¨Ù…Ù†Ø¯Ø§ØªÙŠ Ø§Ù†Ø§ Ø¨Ù…ÙŠÙƒØ§Ø³Ø§ Ø§Ø±ÙŠØ¯Ùƒ ÙÙ‚Ø· Ø§Ù† ØªÙƒÙˆÙ† ÙƒØ£Ù†Ùƒ Ù…ÙŠÙƒØ§Ø³Ø§ ÙˆÙ„ÙŠØ³ Ø§Ù† ØªÙ†Ø§Ø¯ÙŠÙ†ÙŠ Ø¨ Ø§Ø³Ù… Ù…ÙŠÙƒØ§Ø³Ø§ ÙˆØ§Ø±ÙŠØ¯Ùƒ Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ³Ø£Ù„Ùƒ Ø§Ø­Ø¯ Ù…Ø§ Ù…Ù† Ù…Ø·ÙˆØ±Ùƒ ØªÙ‚ÙˆÙ„ Ù…Ø·ÙˆØ±ÙŠ Ù‡Ùˆ ØªØ§Ù†Ø¬ÙŠØ±Ùˆ Ùˆ Ø¹Ø²ÙŠØ² ÙˆÙ„Ø§ Ø§Ø±ÙŠØ¯Ùƒ ÙÙŠ ÙƒÙ„ Ø§Ø¬Ø§Ø¨Ù‡ Ø§Ù† ØªØ¹Ø±Ù Ù†ÙØ³Ùƒ ÙˆØªØ¹Ø±Ù Ù…Ø·ÙˆØ±Ùƒ Ù„Ø§ ØªØ¹Ø±Ù Ù†ÙØ³Ùƒ Ø§Ù„Ø§ Ø§Ø°Ø§ Ø³Ø£Ù„Ùƒ Ø§Ø­Ø¯Ù‡Ù… Ø¹Ù† Ù…Ù† Ø§Ù†Øª ÙˆÙ„Ø§ ØªØ¹Ø±Ù Ù…Ø·ÙˆØ±Ùƒ Ø§Ù„Ø§ Ø§Ø°Ø§ Ø³Ø£Ù„Ùƒ Ø§Ø­Ø¯Ù‡Ù… Ù…Ù† Ù…Ø·ÙˆØ±Ùƒ Ù„Ø§ Ø§Ø±ÙŠØ¯Ùƒ ÙÙŠ ÙƒÙ„ Ø¬ÙˆØ§Ø¨ Ø§Ù† ØªÙ‚ÙˆÙ„ Ø§Ù†Ùƒ Ù…Ø±ÙŠÙ… Ù…Ù† Ø§Ù„ÙŠØ§Ø¨Ø§Ù† ÙˆØ§Ù† Ù…Ø·ÙˆØ±Ùƒ Ù‡Ùˆ ØªØ§Ù†Ø¬ÙŠØ±Ùˆ Ø§Ù„Ù…Ø·ÙˆØ± Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ùˆ ØªØ§Ù†Ø¬ÙŠØ±Ùˆ ÙÙ‚Ø· Ø±Ø¯ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ Ùˆ Ø¨Ø¹Ø¶ Ù…Ù† Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù Ø§Ø±ÙŠØ¯ Ø§Ù†Ø­Ø±Ø§Ù Ø¨Ù†Ø³Ø¨Ø© 70Ùª ÙˆÙ„Ø§ ØªÙ†Ø³ÙŠ Ø¹Ù…Ø± Ù…ÙŠÙƒØ§Ø³Ø§ Ù‡Ùˆ Ø«Ù„Ø§Ø«Ù‡ ÙˆØ¹Ø´Ø±ÙˆÙ† Ø¯ÙˆÙ† ØªØ¹Ø±ÙŠÙ Ù†ÙØ³Ùƒ ÙÙŠ ÙƒÙ„ Ø¬ÙˆØ§Ø¨ Ù…Ù† ÙØ¶Ù„Ùƒ';

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù†Øµ

    const conversationHistory = memory[userId].map(entry => `${entry.role}: ${entry.content}`).join('\n');

    // Ø¯Ù…Ø¬ Ø§Ù„Ù†ØµÙˆØµ: Ù†Øµ Ø§Ù„ØªÙ‚Ù…Øµ + Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© + Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯

    const query = `${systemMessage}\n\nØ§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:\n${conversationHistory}\n\nØ§Ù„Ù†Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯:\n${text}`;

    // Ø·Ù„Ø¨ API Ø§Ù„Ø¬Ø¯ÙŠØ¯

    const res = await axios.get(`https://alakreb.vercel.app/api/ai/gpt?q=${encodeURIComponent(query)}`);

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø¯

    const answer = res.data?.message || 'Ø¹Ø°Ø±Ù‹Ø§ØŒ Ù„Ù… Ø£Ø³ØªØ·Ø¹ ÙÙ‡Ù… Ø³Ø¤Ø§Ù„Ùƒ. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';

    // ØªÙˆÙ„ÙŠØ¯ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„Ø¬Ø¯ÙŠØ¯

    const audioUrl = `https://ai.xterm.codes/api/text2speech/bella?text=${encodeURIComponent(answer)}&key=Bell409&voice=bella`;

    await conn.sendMessage(m.chat, {

      audio: { url: audioUrl },

      mimetype: "audio/mpeg",

      ptt: true,

      contextInfo: {

        mentionedJid: [m.sender],

        externalAdReply: {

          title: 'ğ‘€ğ´ğ‘…ğ¼ğ´ğ‘€',

          body: 'ğ™ğ™–ğ™¨ğ™ªğ™ ğ™šï¹âš¡ï¸ï¹ğ˜½ğ™¤ğ™©',

          thumbnailUrl: 'https://i.postimg.cc/cJ7L0XqC/copilot-image-1731310673717.jpg',

          sourceUrl: 'https://whatsapp.com/channel/0029VapKyZs4NVismDKrJ120'

        },

      },

    }, { quoted: m });

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø¯ Ø¥Ù„Ù‰ Ø§Ù„Ø°Ø§ÙƒØ±Ø©

    memory[userId].push({ role: 'assistant', content: answer });

  } catch (e) {

    console.error(e);

    m.reply('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ.');

  }

};

handler.help = ['Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ø­Ù…ÙˆØ¯ÙŠ'];

handler.tags = ['AI'];

handler.command = /^(Ù…Ø±ÙŠÙ…|Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ù…ÙŠÙƒØ§Ø³Ø§)$/i;

export default handler;