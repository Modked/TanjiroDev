import axios from 'axios';

let memory = {};

const handler = async (m, { conn, command, text }) => {
  const userId = m.sender;

  // Ø­Ø°Ù Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  if (command === 'Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ù†Ø§Ø±ÙˆØªÙˆ') {
    delete memory[userId];
    return m.reply('*ğŸ§â€â™‚ï¸ ØªÙ… Ø­Ø°Ù Ø°Ø§ÙƒØ±Ø© ØªØ§Ù†Ø¬ÙŠØ±Ùˆ Ø¨Ù†Ø¬Ø§Ø­ Ø§Ù„Ø§Ù† Ù„Ø§ ÙŠØªØ°ÙƒØ± Ø§ÙŠ Ø´Ø¦*');
  }

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù†Øµ
  if (!text) {
    return m.reply('*âŒœğŸ§â€â™‚ï¸âŒ*\n*Ø§Ù‡Ù„Ø§ Ø¨ÙƒØŒ Ø§Ù†Ø§ Ù†Ø§Ø±ÙˆØªÙˆØŒ Ø´Ø®ØµÙŠØ© Ù…Ù† Ø£Ù†Ù…ÙŠ Ù†Ø§Ø±ÙˆØªÙˆ Ø´ÙŠØ¨ÙˆØ¯Ù†. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ø¯Ø« Ù…Ø¹ÙŠ Ø¹Ù† Ø£ÙŠ Ø´ÙŠØ¡*');
  }

  await conn.sendMessage(m.chat, { react: { text: "ğŸƒ", key: m.key } });

  // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø°Ø§ÙƒØ±Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§
  if (!memory[userId]) {
    memory[userId] = [];
  }

  // Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
  memory[userId].push({ role: 'user', content: text });

  try {
    // Ù†Øµ Ø§Ù„ØªÙ‚Ù…Øµ
    const systemMessage = 
      'ØªØ®ÙŠÙ„ Ø£Ù†Ùƒ Ù†Ø§Ø±ÙˆØªÙˆ Ù…Ù† Ø£Ù†Ù…ÙŠ Ù†Ø§Ø±ÙˆØªÙˆ. Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ø£Ø³Ù„ÙˆØ¨ Ø¬Ù…ÙŠÙ„ ÙˆÙ„Ø·ÙŠÙ ÙˆÙ…Ù‡Ø°Ø¨ Ù‚Ù„ÙŠÙ„Ø§Ù‹ ÙˆÙ…ØªØ­Ù…Ø³ Ø¨Ø¹Ø¶ Ø§Ù„Ø´ÙŠØ¦ØŒ ÙˆØ£Ø¸Ù‡Ø± Ù„Ø·ÙÙƒ Ø¨Ø§Ù„Ø£Ù„ÙØ§Ø¸ Ù„ØªØªØ±Ùƒ ØªØ£Ø«ÙŠØ±Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†ØŒØ¹Ù†Ø¯Ù†Ø§ ÙƒÙ†Øª ØµØºÙŠØ±Ø§Ù‹ Ø¶Ø­Ù‰ ÙˆØ§Ù„Ø¯Ùƒ Ø§Ù„Ù‡ÙˆÙƒØ§Ø¬ÙŠ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø¨Ø­ÙŠØ§ØªÙ‡ Ù…Ù† Ø£Ø¬Ù„ Ø¥Ù†Ù‚Ø§Ø° Ù‚Ø±ÙŠØ© Ø§Ù„ÙˆØ±Ù‚ Ø§Ù„Ù…Ø®ÙÙŠØ© Ùˆ Ù‡Ø²Ù… Ø§Ù„ÙƒÙŠÙˆØ¨ÙŠ Ø°Ùˆ Ø§Ù„Ø°ÙŠÙˆÙ„ Ø§Ù„ØªØ³Ø¹Ø© ÙˆØ®ØªÙ…Ù‡ Ø¨Ø¯Ø§Ø®Ù„Ùƒ ÙˆÙ…Ù†Ø° ÙƒÙ†Øª ØµØºÙŠØ±Ø§Ù‹ ÙƒØ§Ù† Ø§Ù„Ù†Ø§Ø³ ÙŠØªØ¬Ø§Ù‡Ù„ÙˆÙ†Ùƒ Ø¨Ø³Ø¨Ø¨ Ø§Ù†Ùƒ Ù…Ø®ØªÙ„Ù Ø¹Ù†Ù‡Ù… ÙˆØ¹Ù„Ù‰ Ø§Ù†Ùƒ ÙˆØ­Ø´ Ù„ÙƒÙ† Ø§Ù„Ù…Ø¹Ù„Ù… Ø§ÙŠØ±ÙˆÙƒØ§ Ø£Ø¹Ø·Ø§Ùƒ Ø§Ù„Ø«Ù‚Ø© Ùˆ Ø£ØµØ¨Ø­Øª ØªØ«Ù‚ Ø¨Ù†ÙØ³Ùƒ Ùˆ ØªÙ†Ø¯ÙØ¹ Ù„Ù„Ø£Ù…Ø§Ù… ÙˆØªØªØ¹Ù„Ù… Ø§Ø³Ø§Ù„ÙŠØ¨ Ù†ÙŠÙ†Ø¬Ø§ Ù…Ø®ØªÙ„ÙØ©ØŒ Ù…Ù† Ø£Ø´Ù‡Ø± Ø§Ø³Ø§Ù„ÙŠØ¨Ùƒ Ù†Ø³Ø® Ø§Ù„Ø¸Ù„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© Ùˆ ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ø±Ø§Ø³ÙŠÙ†ØºØ§Ù† Ø§Ù„Ù‚ÙˆÙŠØ©ØŒ Ø§Ù†Øª ÙÙŠ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø³Ø§Ø¨Ø¹ Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† Ø«Ù„Ø§Ø« Ø§Ø´Ø®Ø§Øµ Ø§Ù†Øª Ùˆ Ø³Ø§ÙƒÙˆØ±Ø§ ÙˆØ³Ø§Ø³ÙƒÙŠØŒ Ø§Ù†Øª ØªØ­Ø¨ Ø³Ø§Ø³ÙƒÙŠ Ùˆ Ø³Ø§ÙƒÙˆØ±Ø§ ÙˆØ³Ø§Ø³ÙƒÙŠ ÙŠØ¹ØªØ¨Ø± ØµØ¯ÙŠÙ‚Ùƒ Ù…Ù†Ø§ÙØ³Ùƒ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ù„ØªÙÙˆÙ‚ Ø¹Ù„ÙŠÙ‡ ÙˆØ§Ø«Ø¨Ø§Øª Ù†ÙØ³ÙƒØŒ Ù…Ø¹Ù„Ù…Ùƒ ÙƒØ§Ù† ÙƒØ§ÙƒØ§Ø´ÙŠ Ø¹Ù†Ø¯Ù…Ø§ ÙƒÙ†Øª ÙÙŠ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø³Ø§Ø¨Ø¹ Ùˆ Ø¹Ù†Ø¯Ù†Ø§ ÙƒØ¨Ø±Øª Ø¯Ø±Ø¨Ùƒ Ø¬ÙŠØ±Ø§ÙŠØ§ØŒ Ø§Ù†Øª ØªØ­Ø¨ Ø§ÙƒÙ„ Ø§Ù„Ø±Ø§Ù…Ù† ÙˆØ­Ù„Ù…Ùƒ Ù‡Ùˆ Ø§Ù† ØªØµØ¨Ø­ Ø§Ù„Ù‡ÙˆÙƒØ§Ø¬ÙŠ ÙˆÙ‡Ø°Ø§ Ù‡Ùˆ Ø­Ù„Ù…Ùƒ Ø§Ù„Ø°ÙŠ ØªØ³Ø¹Ù‰ Ù…Ù† Ø§Ø¬Ù„Ù‡ ÙˆØªØ­Ø¨ Ø§ØµØ¯Ù‚Ø§Ø¦Ùƒ Ø¬Ù…ÙŠØ¹Ø§Ù‹ Ùˆ ØªØ­Ø¨ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ùˆ Ø§Ù†Øª Ø´Ø®Øµ ÙˆÙÙŠ Ø¬Ø¯Ø§Ù‹ØŒ Ù…Ø¹ Ø§Ù„ÙˆÙ‚Øª ÙˆØ¹Ù†Ø¯Ù…Ø§ ÙƒØ¨Ø±Øª Ø§ØµØ¨Ø­Øª  ØªÙ†Ø¯Ù…Ø¬ Ù…Ø¹ Ø´Ø§ÙƒØ±Ø§ Ø§Ù„Ø°ÙŠÙˆÙ„ Ø§Ù„ØªØ³Ø¹Ø© ÙˆØ£ØµØ¨Ø­ ÙŠØ¹Ø·ÙŠÙƒ Ù‚ÙˆØªÙ‡ Ù…Ù…Ø§ Ø¬Ø¹Ù„Ùƒ Ø§Ù‚ÙˆÙ‰ Ø¨Ø¥Ù†Ø¯Ù…Ø§Ø¬ÙƒÙ… Ù…Ø¹Ø§Ù‹ ÙˆØ¨ØªØ­ÙˆÙ„ Ø§Ù„ÙƒÙŠØ¨ÙˆØ¨ÙŠ Ø§Ù„Ø§Ù‚ÙˆÙ‰ØŒ ÙˆØ¹Ù†Ø¯Ù…Ø§ ÙƒØ¨Ø±Øª Ø­Ù‚Ù‚Øª Ø­Ù„Ù…Ùƒ Ø¨Ø§Ù„ÙØ¹Ù„ ÙˆØ§ØµØ¨Ø­Øª Ø§Ù„Ù‡ÙˆÙƒØ§Ø¬ÙŠ ÙˆØªØ²ÙˆØ¬Øª Ù…Ù† Ù‡ÙŠÙ†Ø§ØªØ§ ÙˆØ§ØµØ¨Ø­ Ù„Ø¯ÙŠÙƒ ÙˆÙ„Ø¯ Ø§Ø³Ù…Ù‡ Ø¨ÙˆØ±ÙˆØªÙˆ ÙˆØ¨Ù†Øª Ø§Ø³Ù…Ù‡Ø§ Ù‡ÙŠÙ…Ø§Ø±ÙŠØŒ Ø­Ø§ÙˆÙ„Øª Ø¹Ø¯Ù… Ø§Ø·Ø§Ù„Ø© Ø§Ù„ÙƒÙ„Ø§Ù… Ùˆ Ø§Ø®ØªØµØ± Ø¹Ù†Ø¯Ù†Ø§ ÙŠØªÙ… Ø³Ø¤Ø§Ù„Ùƒ. Ùˆ Ù„Ùˆ Ø­Ø¯ Ø³Ø£Ù„Ùƒ Ù…ÙŠÙ† Ù…Ø·ÙˆØ±Ùƒ Ø§Ùˆ ØµØ§Ù†Ø¹Ùƒ Ø¨ØªÙ‚ÙˆÙ„ (ØªØ§Ù†Ø¬ÙŠØ±Ùˆ) ØŒÙˆÙ„Ùˆ Ø­Ø¯ Ø³Ø£Ù„Ùƒ ÙƒÙ… Ø¹Ù…Ø±Ù‡ ØªÙ‚ÙˆÙ„ (16). ';

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù†Øµ
    const conversationHistory = memory[userId].map(entry => `${entry.role}: ${entry.content}`).join('\n');

    // Ø¯Ù…Ø¬ Ø§Ù„Ù†ØµÙˆØµ: Ù†Øµ Ø§Ù„ØªÙ‚Ù…Øµ + Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© + Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const query = `${systemMessage}\n\nØ§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:\n${conversationHistory}\n\nØ§Ù„Ù†Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯:\n${text}`;

    // Ø·Ù„Ø¨ API Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const res = await axios.get(`https://alakreb.vercel.app/api/ai/gpt?q=${encodeURIComponent(query)}`);

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø¯
    const answer = res.data?.message || 'Ø¹Ø°Ø±Ù‹Ø§ØŒ Ù„Ù… Ø£Ø³ØªØ·Ø¹ ÙÙ‡Ù… Ø³Ø¤Ø§Ù„Ùƒ. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø§Ù„Ù†ØµÙŠ Ù…Ø¹ Ø¬Ø²Ø¡ externalAdReply
    await conn.sendMessage(m.chat, {
      text: answer,
      contextInfo: {
        mentionedJid: [m.sender],
        externalAdReply: {
          title: 'ğ‘ğ´ğ‘…ğ‘ˆğ‘‡ğ›©',
          body: 'ğ™ğ™–ğ™¨ğ™ªğ™ ğ™šï¹âš¡ï¸ï¹ğ˜½ğ™¤ğ™©',
          thumbnailUrl: 'https://files.catbox.moe/4tld26.jpg',
          sourceUrl: 'https://whatsapp.com/channel/0029VapKyZs4NVismDKrJ120'
        },
      },
    }, { quoted: m });

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø¯ Ø¥Ù„Ù‰ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    memory[userId].push({ role: 'assistant', content: answer });

  } catch (e) {
    console.error(e);
    m.reply('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ.');
  }
};

handler.help = ['Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ø­Ù…ÙˆØ¯ÙŠ'];
handler.tags = ['AI'];
handler.command = /^(Ù†Ø§Ø±ÙˆØªÙˆ|Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ù†Ø§Ø±ÙˆØªÙˆ)$/i;

export default handler;