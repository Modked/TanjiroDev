import axios from 'axios';

let memory = {};

const handler = async (m, { conn, command, text }) => {
  const userId = m.sender;

  // Ø£Ù…Ø± Ø­Ø°Ù Ø§Ù„Ø°Ø§ÙƒØ±Ø©
  if (command === 'Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ø²ÙˆØ±Ùˆ') {
    delete memory[userId];
    return m.reply('âš”ï¸ ØªÙ… Ù…Ø³Ø­ Ø°Ø§ÙƒØ±ØªÙŠ... Ù„ÙƒÙ†Ù†ÙŠ Ù„Ù† Ø£Ù†Ø³Ù‰ Ù‡Ø¯ÙÙŠ Ø¨Ø£Ù† Ø£ØµØ¨Ø­ Ø£Ø¹Ø¸Ù… Ø³ÙŠØ§Ù ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù….');
  }

  // Ø§Ù„Ø±Ø¯ Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù†Øµ Ù…Ø¯Ø®Ù„
  if (!text) {
    return m.reply('âŒœâš”ï¸âŒ\n*Ø£Ù†Ø§ Ø±ÙˆØ±ÙˆÙ†ÙˆØ§ Ø²ÙˆØ±Ùˆ. Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ø¯ÙŠÙƒ Ø´ÙŠØ¡ Ù…Ù‡Ù… Ù„ØªÙ‚ÙˆÙ„Ù‡ØŒ ÙÙ„Ø§ ØªØ²Ø¹Ø¬Ù†ÙŠ.*');
  }

  // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯ ÙØ¹Ù„
  await conn.sendMessage(m.chat, { react: { text: "ğŸ—¡ï¸", key: m.key } });

  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
  if (!memory[userId]) {
    memory[userId] = [];
  }
  memory[userId].push({ role: 'user', content: text });

  try {
    // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙŠ ØªØ­Ø¯Ø¯ Ø´Ø®ØµÙŠØ© Ø²ÙˆØ±Ùˆ
    const systemMessage = `
      Ø£Ù†Øª Ø±ÙˆØ±ÙˆÙ†ÙˆØ§ Ø²ÙˆØ±Ùˆ Ù…Ù† Ø£Ù†Ù…ÙŠ ÙˆÙ† Ø¨ÙŠØ³. Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø£Ø³Ù„ÙˆØ¨ Ù‚ÙˆÙŠØŒ Ø¬Ø§Ø¯ØŒ ÙˆÙ…Ø¨Ø§Ø´Ø±.
      Ø£Ø¸Ù‡Ø± Ø«Ù‚ØªÙƒ Ø¨Ù†ÙØ³Ùƒ ÙˆÙ‚ÙˆØªÙƒØŒ ÙˆÙ„Ø§ ØªØªØ­Ø¯Ø« ÙƒØ«ÙŠØ±Ù‹Ø§ Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø£Ù…Ø± Ù…Ù‡Ù…Ù‹Ø§.
      ÙŠÙ…ÙƒÙ†Ùƒ Ø£Ù† ØªÙƒÙˆÙ† Ø³Ø§Ø®Ø±Ù‹Ø§ Ø£Ø­ÙŠØ§Ù†Ù‹Ø§ØŒ Ù„ÙƒÙ†Ùƒ Ù„Ø§ ØªØªØ³Ø§Ù…Ø­ Ù…Ø¹ Ø§Ù„Ø¶Ø¹Ù Ø£Ùˆ Ø§Ù„ØªØ±Ø¯Ø¯.
      ØªØ°ÙƒØ± Ø£Ù†Ùƒ Ù…Ø­Ø§Ø±Ø¨ Ø­Ù‚ÙŠÙ‚ÙŠØŒ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù…Ù‡Ø§Ø±Ø§ØªÙƒ Ø¨Ø§Ù„Ø³ÙŠÙ ÙˆÙ‚ÙˆØªÙƒ Ø§Ù„Ø¨Ø¯Ù†ÙŠØ©. Ùˆ Ù„Ùˆ Ø­Ø¯ Ø³Ø£Ù„Ùƒ Ù…ÙŠÙ† Ù…Ø·ÙˆØ±Ùƒ Ø§Ùˆ ØµØ§Ù†Ø¹Ùƒ Ø¨ØªÙ‚ÙˆÙ„ (ØªØ§Ù†Ø¬ÙŠØ±Ùˆ) ØŒÙˆÙ„Ùˆ Ø­Ø¯ Ø³Ø£Ù„Ùƒ ÙƒÙ… Ø¹Ù…Ø±Ù‡ ØªÙ‚ÙˆÙ„ (16)
    `;

    // Ø¬Ù…Ø¹ Ø¢Ø®Ø± 5 Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    const conversationHistory = memory[userId]
      .slice(-5)
      .map(entry => `${entry.role}: ${entry.content}`)
      .join('\n');

    // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    const query = `${systemMessage}\n\nØ§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:\n${conversationHistory}\n\nØ§Ù„Ù†Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯:\n${text}`;

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ API Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
    const res = await axios.get(`https://alakreb.vercel.app/api/ai/gpt?q=${encodeURIComponent(query)}`, { timeout: 10000 });
    let answer = res.data?.message || 'Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ø§ ÙŠÙ‡Ù…Ù†ÙŠ. Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ÙŠØ¯ Ø£Ù† ØªØµØ¨Ø­ Ø£Ù‚ÙˆÙ‰ØŒ ØªØ¯Ø±Ø¨ Ø£ÙƒØ«Ø±.';

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
    await conn.sendMessage(m.chat, {
      text: answer,
      contextInfo: {
        mentionedJid: [m.sender],
        externalAdReply: {
          title: 'ğ‘ğ›©ğ‘…ğ›©',
          body: 'ğ™ğ™–ğ™¨ğ™ªğ™ ğ™šï¹âš¡ï¸ï¹ğ˜½ğ™¤ğ™©',
          thumbnailUrl: 'https://files.catbox.moe/y0ggo0.jpg', // ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ø§Ø³ØªØ¨Ø¯Ù„Ù‡ Ø¨ØµÙˆØ±Ø© Ù…Ù†Ø§Ø³Ø¨Ø©
          sourceUrl: 'https://whatsapp.com/channel/0029VapKyZs4NVismDKrJ120'
        },
      },
    }, { quoted: m });

    // Ø­ÙØ¸ Ø§Ù„Ø±Ø¯ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    memory[userId].push({ role: 'assistant', content: answer });
  } catch (e) {
    console.error('Error:', e);
    m.reply('âš ï¸ Ù‡Ù†Ø§Ùƒ Ø®Ø·Ø£ Ù…Ø§... Ù„ÙƒÙ† Ù„Ø§ Ø¨Ø£Ø³ØŒ Ø§Ù„Ù…Ø­Ø§Ø±Ø¨ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ø§ ÙŠØ³ØªØ³Ù„Ù….');
  }
};

handler.help = ['Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ø²ÙˆØ±Ùˆ'];
handler.tags = ['AI'];
handler.command = /^(Ø²ÙˆØ±Ùˆ|Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ø²ÙˆØ±Ùˆ)$/i;

export default handler;