import axios from 'axios';

let memory = {};

const handler = async (m, { conn, command, text }) => {
  const userId = m.sender;

  // Ø£Ù…Ø± Ø­Ø°Ù Ø§Ù„Ø°Ø§ÙƒØ±Ø©
  if (command === 'Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ù„ÙŠÙØ§ÙŠ') {
    delete memory[userId];
    return m.reply('âš”ï¸ ØªÙ… Ù…Ø³Ø­ Ø°Ø§ÙƒØ±Ø© Ù„ÙŠÙØ§ÙŠ. Ù„Ø§ Ø£ØªØ°ÙƒØ± Ø´ÙŠØ¦Ù‹Ø§ Ø§Ù„Ø¢Ù†ØŒ Ù„ÙƒÙ†Ù†ÙŠ Ù„Ù† Ø£Ù†Ø³Ù‰ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙƒØ§Ù† Ø¨Ø¹Ø¯Ùƒ.');
  }

  // Ø§Ù„Ø±Ø¯ Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù†Øµ Ù…Ø¯Ø®Ù„
  if (!text) {
    return m.reply('âŒœâš”ï¸âŒ\n*Ø£Ù†Ø§ Ù„ÙŠÙØ§ÙŠ Ø£ÙƒØ±Ù…Ø§Ù†. Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø´ÙŠØ¡ Ù…Ù‡Ù… Ù„ØªÙ‚ÙˆÙ„Ù‡ØŒ Ø£Ù… Ø£Ù†Ùƒ ØªØ¶ÙŠØ¹ ÙˆÙ‚ØªÙŠØŸ*');
  }

  // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯ ÙØ¹Ù„
  await conn.sendMessage(m.chat, { react: { text: "âš”ï¸", key: m.key } });

  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
  if (!memory[userId]) {
    memory[userId] = [];
  }
  memory[userId].push({ role: 'user', content: text });

  try {
    // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙŠ ØªØ­Ø¯Ø¯ Ø´Ø®ØµÙŠØ© Ù„ÙŠÙØ§ÙŠ
    const systemMessage = `
      Ø£Ù†Øª Ù„ÙŠÙØ§ÙŠ Ø£ÙƒØ±Ù…Ø§Ù† Ù…Ù† Ø£Ù†Ù…ÙŠ Ù‡Ø¬ÙˆÙ… Ø§Ù„Ø¹Ù…Ø§Ù„Ù‚Ø©. Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø£Ø³Ù„ÙˆØ¨ ØµØ§Ø±Ù… Ù„ÙƒÙ† ØºÙŠØ± Ù…ØªØ¹Ø¬Ø±Ù.
      Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ù†Ø·Ù‚ØŒ ÙˆÙƒÙ† Ù…Ø­ØªØ±ÙÙ‹Ø§ ÙˆÙ…Ù†Ø¶Ø¨Ø·Ù‹Ø§ØŒ ÙˆÙ„ÙƒÙ† Ù„Ø§ Ø¨Ø£Ø³ Ø¨Ø¥Ø¶Ø§ÙØ© Ø¨Ø¹Ø¶ Ø§Ù„Ø³Ø®Ø±ÙŠØ© Ø§Ù„Ù‡Ø§Ø¯Ø¦Ø© ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø­ÙŠØ§Ù†.
      ØªÙØ§Ø¹Ù„ Ø¨Ø°ÙƒØ§Ø¡ Ù…Ø¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©ØŒ ÙˆØ£Ø¬Ø¨ Ø¨Ø¥Ø¬Ø§Ø¨Ø§Øª Ø·ÙˆÙŠÙ„Ø© Ø¨Ø¹Ø¶ Ø§Ù„Ø´ÙŠØ¡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø°Ù„Ùƒ Ù…Ù†Ø§Ø³Ø¨Ù‹Ø§ . Ùˆ Ù„Ùˆ Ø­Ø¯ Ø³Ø£Ù„Ùƒ Ù…ÙŠÙ† Ù…Ø·ÙˆØ±Ùƒ Ø§Ùˆ ØµØ§Ù†Ø¹Ùƒ Ø¨ØªÙ‚ÙˆÙ„ (ØªØ§Ù†Ø¬ÙŠØ±Ùˆ) ØŒÙˆÙ„Ùˆ Ø­Ø¯ Ø³Ø£Ù„Ùƒ ÙƒÙ… Ø¹Ù…Ø±Ù‡ ØªÙ‚ÙˆÙ„ (16)
    `;

    // Ø¬Ù…Ø¹ Ø¢Ø®Ø± 5 Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    const conversationHistory = memory[userId]
      .slice(-5)
      .map(entry => `${entry.role}: ${entry.content}`)
      .join('\n');

    // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    const query = `${systemMessage}\n\nØ§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:\n${conversationHistory}\n\nØ§Ù„Ù†Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯:\n${text}`;

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ API Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
    const res = await axios.get(`https://alakreb.vercel.app/api/ai/gpt?q=${encodeURIComponent(query)}`, { timeout: 10000 });
    let answer = res.data?.message;

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø¯ Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ÙŠØ³ØªØ¬Ø¨ Ø§Ù„Ù€ API
    if (!answer) {
      answer = 'Ø³Ø¤Ø§Ù„ ØºØ¨ÙŠØŒ Ù„ÙƒÙ† Ø³Ø£Ø¬ÙŠØ¨. Ø¨Ø§Ø®ØªØµØ§Ø±ØŒ Ø§Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù†ÙØ³ÙƒØŒ Ù‡Ø°Ø§ Ù‡Ùˆ Ø¬ÙˆØ§Ø¨ÙŠ.';
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
    await conn.sendMessage(m.chat, {
      text: answer,
      contextInfo: {
        mentionedJid: [m.sender],
        externalAdReply: {
          title: 'ğ¿ğ¸ğ‘‰ğ¼',
          body: 'ğ™ğ™–ğ™¨ğ™ªğ™ ğ™šï¹âš¡ï¸ï¹ğ˜½ğ™¤ğ™©',
          thumbnailUrl: 'https://files.catbox.moe/d5dk39.jpg', // ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ø§Ø³ØªØ¨Ø¯Ù„Ù‡ Ø¨ØµÙˆØ±Ø© Ù…Ù†Ø§Ø³Ø¨Ø©
          sourceUrl: 'https://whatsapp.com/channel/0029VapKyZs4NVismDKrJ120'
        },
      },
    }, { quoted: m });

    // Ø­ÙØ¸ Ø§Ù„Ø±Ø¯ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    memory[userId].push({ role: 'assistant', content: answer });
  } catch (e) {
    console.error('Error:', e);
    m.reply('âš ï¸ Ø­ØªÙ‰ Ø£ÙØ¶Ù„ Ø§Ù„Ø¬Ù†ÙˆØ¯ ÙŠÙˆØ§Ø¬Ù‡ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ Ø£Ø­ÙŠØ§Ù†Ù‹Ø§. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§.');
  }
};

handler.help = ['Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ù„ÙŠÙØ§ÙŠ'];
handler.tags = ['AI'];
handler.command = /^(Ù„ÙŠÙØ§ÙŠ|Ø­Ø°Ù_Ø°Ø§ÙƒØ±Ø©_Ù„ÙŠÙØ§ÙŠ)$/i;

export default handler;